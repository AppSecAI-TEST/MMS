/*
 * Copyright (C) 2015 Brockmann Consult GmbH
 * This code was developed for the EC project "Fidelity and Uncertainty in
 * Climate Data Records from Earth Observations (FIDUCEO)".
 * Grant Agreement: 638822
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 3 of the License, or (at your option)
 * any later version.
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
 * more details.
 *
 * A copy of the GNU General Public License should have been supplied along
 * with this program; if not, see http://www.gnu.org/licenses/
 *
 */

package com.bc.fiduceo.ingest;

import com.bc.fiduceo.TestUtil;
import com.bc.fiduceo.core.NodeType;
import com.bc.fiduceo.core.SatelliteObservation;
import com.bc.fiduceo.db.DbAndIOTestRunner;
import com.bc.fiduceo.db.Storage;
import com.bc.fiduceo.geometry.Geometry;
import com.bc.fiduceo.geometry.GeometryCollection;
import com.bc.fiduceo.geometry.GeometryFactory;
import org.apache.commons.cli.ParseException;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;

import java.io.File;
import java.io.IOException;
import java.sql.SQLException;
import java.util.List;
import java.util.Properties;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;
import static org.junit.Assert.fail;

@RunWith(DbAndIOTestRunner.class)
public class IngestionToolIntegrationTest {

    private File configDir;
    private String sep;
    private GeometryFactory geometryFactory;

    @Before
    public void setUp() {
        final File testDirectory = TestUtil.createTestDirectory();
        configDir = new File(testDirectory, "config");
        if (!configDir.mkdir()) {
            fail("unable to create testGroupInputProduct directory: " + configDir.getAbsolutePath());
        }

        sep = File.separator;
        geometryFactory = new GeometryFactory(GeometryFactory.Type.S2);
    }

    @After
    public void tearDown() {
        TestUtil.deleteTestDirectory();
    }

    @Test
    public void testIngest_notInputParameter() throws ParseException, IOException, SQLException {
        // @todo 4 tb/tb find a way to steal system.err to implement assertions 2015-12-09
        final String[] args = new String[0];
        IngestionToolMain.main(args);
    }

    @Test
    public void testIngest_help() throws ParseException, IOException, SQLException {
        // @todo 4 tb/tb find a way to steal system.err to implement assertions 2015-12-09
        String[] args = new String[]{"-h"};
        IngestionToolMain.main(args);

        args = new String[]{"--help"};
        IngestionToolMain.main(args);
    }

    @Test
    public void testIngest_missingSystemProperties() throws ParseException, IOException, SQLException {
        final String[] args = new String[]{"-c", configDir.getAbsolutePath(), "-s", "airs-aqua"};

        TestUtil.writeDatabaseProperties_MongoDb(configDir);

        try {
            IngestionToolMain.main(args);
            fail("RuntimeException expected");
        } catch (RuntimeException expected) {
        }
    }

    @Test
    public void testIngest_missingDatabaseProperties() throws ParseException, IOException, SQLException {
        final String[] args = new String[]{"-c", configDir.getAbsolutePath(), "-s", "airs-aqua"};

        writeSystemProperties();

        try {
            IngestionToolMain.main(args);
            fail("RuntimeException expected");
        } catch (RuntimeException expected) {
        }
    }

    @Test
    public void testIngest_AVHRR_GAC_NOAA17() throws SQLException, IOException, ParseException {
        final String expectedGeometry_1 = "POLYGON((-66.97299194335938 -5.238999843597412,-67.67599487304688 -2.365999937057496,-68.343994140625 0.5130000114440918,-68.97698974609375 3.3970000743865967,-69.5780029296875 6.2870001792907715,-70.14700317382812 9.180000305175781,-70.68798828125 12.076000213623047,-71.19900512695312 14.975000381469721,-71.68301391601562 17.87700080871582,-72.13900756835938 20.780000686645504,-72.56600952148438 23.6830005645752,-72.9639892578125 26.587999343872067,-73.3330078125 29.492000579833984,-73.67098999023438 32.395999908447266,-73.97500610351564 35.299999237060554,-74.24301147460938 38.20199966430664,-74.47100830078125 41.10200119018555,-74.65399169921875 44.000999450683594,-74.7860107421875 46.89699935913086,-74.85800170898438 49.78900146484375,-74.85699462890625 52.678001403808594,-74.76901245117188 55.5629997253418,-74.57199096679688 58.44300079345703,-74.2349853515625 61.316001892089844,-73.7139892578125 64.18099975585938,-72.94400024414062 67.03500366210938,-71.82101440429689 69.8740005493164,-70.17898559570312 72.69200134277344,-67.72500610351564 75.47599792480467,-63.90899658203124 78.20500183105469,-57.592010498046875 80.8280029296875,-46.20401000976563 83.2249984741211,-24.2969970703125 85.0550003051758,10.654000282287598 85.552001953125,40.69599914550781 84.3550033569336,57.08399963378906 82.20800018310547,65.75800323486328 79.68900299072266,70.76599884033203 77.01300048828125,73.88600158691406 74.25900268554688,75.93299865722656 71.46199798583984,77.31800079345703 68.63800048828125,78.2699966430664 65.7959976196289,78.9209976196289 62.942001342773445,79.35500335693361 60.08000183105469,79.6259994506836 57.209999084472656,79.77300262451172 54.33599853515625,79.82099914550781 51.456001281738295,79.78900146484375 48.57400131225586,79.69100189208984 45.6889991760254,79.53700256347656 42.80099868774414,79.33499908447266 39.9109992980957,79.08999633789062 37.02000045776367,78.80699920654297 34.12799835205078,78.48999786376953 31.235000610351562,78.13999938964844 28.341999053955078,77.76000213623047 25.44899940490723,77.35099792480469 22.55699920654297,76.91400146484375 19.66500091552735,76.4489974975586 16.774999618530266,75.9560012817383 13.885999679565428,75.43499755859375 11.00100040435791,74.88500213623047 8.11800003051758,74.30599975585939 5.237999916076658,73.69599914550781 2.364000082015991,73.052001953125 -0.5059999823570249,72.3740005493164 -3.369999885559082,71.65899658203125 -6.228000164031982,70.90399932861328 -9.079000473022461,70.10600280761719 -11.920999526977539,69.81500244140625 -12.91300010681152,74.89600372314453 -13.925000190734863,77.65799713134766 -14.428000450134277,79.61900329589844 -14.763999938964844,81.2239990234375 -15.026000022888185,82.68000030517578 -15.253000259399416,84.125 -15.468999862670898,85.69100189208984 -15.692000389099123,87.56600189208984 -15.944000244140623,90.1259994506836 -16.260000228881836,94.50199890136719 -16.72500038146972,95.91200256347656 -16.854999542236328,96.4000015258789 -13.965999603271488,96.91699981689453 -11.07800006866455,97.46199798583984 -8.194000244140629,98.03600311279297 -5.311999797821045,98.64099884033205 -2.434999942779541,99.27799987792969 0.43799999356269836,99.94999694824219 3.305999994277954,100.65799713134767 6.169000148773194,101.40499877929688 9.022999763488775,102.19599914550783 11.87100028991699,103.03299713134766 14.70899963378906,103.9209976196289 17.537000656127926,104.86499786376953 20.354000091552734,105.87300109863281 23.158000946044922,106.9489974975586 25.947999954223633,108.1050033569336 28.721000671386726,109.3489990234375 31.475999832153317,110.69300079345703 34.20899963378906,112.15100097656251 36.918998718261726,113.73999786376955 39.599998474121094,115.47899627685547 42.249000549316406,117.39299774169923 44.861000061035156,119.51000213623047 47.428001403808594,121.86399841308595 49.943000793457024,124.49500274658203 52.39599990844727,127.45200347900392 54.77399826049805,130.79100036621094 57.06100082397461,134.5780029296875 59.23799896240235,138.88400268554688 61.279998779296875,143.781005859375 63.15599822998047,149.33299255371094 64.83100128173828,155.57899475097656 66.26100158691406,162.50900268554688 67.4010009765625,170.03599548339844 68.20500183105469,177.98500061035156 68.63500213623047,-173.89599609375 68.66899871826172,-165.89700317382812 68.30400085449219,-158.281005859375 67.55999755859375,-151.23899841308597 66.4729995727539,-144.87100219726562 65.08599853515625,-139.1999969482422 63.44699859619141,-134.1929931640625 61.59899902343751,-129.78900146484375 59.57799911499023,-125.91700744628908 57.417999267578125,-122.5050048828125 55.141998291015625,-119.48599243164064 52.77199935913085,-116.80200195312503 50.32500076293945,-114.40400695800781 47.81200027465822,-112.24899291992189 45.24499893188476,-110.302001953125 42.63199996948242,-108.53399658203125 39.97999954223633,-106.92100524902347 37.293998718261726,-105.44200134277344 34.578998565673835,-104.08000183105472 31.839000701904293,-102.82000732421875 29.076999664306644,-101.64999389648438 26.29599952697754,-100.56100463867189 23.496999740600586,-99.54299926757814 20.683000564575195,-98.5880126953125 17.85700035095215,-97.69198608398438 15.017999649047848,-96.84698486328125 12.168999671936035,-96.04901123046875 9.3100004196167,-95.29598999023438 6.443999767303467,-94.58099365234375 3.569999933242798,-93.90499877929688 0.6899999976158142,-93.26300048828125 -2.19600009918213,-92.65399169921875 -5.085000038146971,-92.07501220703125 -7.979000091552735,-91.8800048828125 -8.993000030517582,-87.0469970703125 -8.380999565124512,-84.39999389648438 -8.020000457763675,-82.51998901367188 -7.752999782562255,-80.98199462890625 -7.5279998779296875,-79.58700561523438 -7.318999767303464,-78.20401000976562 -7.1069998741149885,-76.70599365234375 -6.873000144958496,-74.91500854492188 -6.586999893188475,-72.4739990234375 -6.185999870300293,-68.31100463867188 -5.473999977111816,-66.97299194335938 -5.238999843597412))";
        final String expectedGeometry_2 = "POLYGON((69.81500244140625 -12.91300010681152,68.9520034790039 -15.741999626159663,68.03500366210938 -18.559999465942383,67.05899810791016 -21.36599922180175,66.01699829101562 -24.158000946044925,64.9020004272461 -26.93400001525879,63.70500183105469 -29.69099998474122,62.41400146484374 -32.430000305175774,61.016998291015625 -35.14500045776367,59.5009994506836 -37.83399963378906,57.84600067138673 -40.49300003051758,56.030998229980476 -43.11600112915039,54.03300094604492 -45.69900131225587,51.81999969482422 -48.23500061035156,49.356998443603516 -50.7130012512207,46.599998474121094 -53.12400054931641,43.50199890136719 -55.452999114990234,40.000999450683594 -57.683998107910156,36.0359992980957 -59.79600143432618,31.53400039672852 -61.76100158691407,26.43000030517578 -63.54899978637696,20.670000076293938 -65.12100219726562,14.237000465393065 -66.43399810791016,7.164999961853029 -67.44300079345703,-0.430999755859375 -68.10600280761719,-8.35101318359375 -68.39299774169922,-16.334991455078125 -68.28700256347656,-24.110992431640632 -67.79299926757812,-31.446990966796875 -66.93800354003906,-38.18701171875 -65.75700378417969,-44.26199340820311 -64.2969970703125,-49.66598510742188 -62.60100173950195,-54.441009521484375 -60.709999084472656,-58.647003173828125 -58.65700149536133,-62.35598754882813 -56.472999572753906,-65.63400268554688 -54.18000030517578,-68.54299926757812 -51.79899978637696,-71.13699340820312 -49.34299850463867,-73.46099853515625 -46.825000762939446,-75.55499267578125 -44.25400161743164,-77.45098876953125 -41.63999938964844,-79.177001953125 -38.98699951171876,-80.7550048828125 -36.30199813842774,-82.20498657226562 -33.588001251220696,-83.54299926757812 -30.84900093078614,-84.78201293945312 -28.089000701904297,-85.93399047851562 -25.309000015258796,-87.00799560546875 -22.511999130249027,-88.01300048828125 -19.701000213623047,-88.95498657226562 -16.875999450683594,-89.84201049804688 -14.038999557495117,-90.67800903320312 -11.192000389099121,-91.46701049804688 -8.335000038146973,-92.2139892578125 -5.46999979019165,-92.92098999023438 -2.5980000495910645,-93.59100341796875 0.2809999883174896,-94.22698974609375 3.1649999618530273,-94.82998657226564 6.053999900817871,-95.40200805664062 8.946999549865723,-95.94500732421875 11.843000411987305,-96.45901489257812 14.741999626159664,-96.94500732421875 17.643999099731445,-97.40200805664062 20.54700088500977,-97.83200073242188 23.451000213623054,-98.2330017089844 26.354999542236328,-98.60400390625 29.260000228881836,-98.94400024414062 32.16400146484375,-99.25100708007812 35.06700134277344,-99.52200317382814 37.970001220703125,-99.60598754882812 38.95600128173828,-105.968994140625 38.71099853515626,-109.39300537109378 38.43399810791015,-111.79899597167969 38.178001403808594,-113.75 37.93299865722656,-115.5050048828125 37.68299865722657,-117.23100280761722 37.4099998474121,-119.08299255371092 37.08700180053711,-121.27299499511719 36.66299819946289,-124.21000671386719 36.02299880981445,-129.08299255371094 34.775001525878906,-130.60899353027344 34.334999084472656,-129.2570037841797 31.591999053955085,-128.00599670410156 28.827999114990234,-126.84300231933595 26.045000076293945,-125.76100158691406 23.2450008392334,-124.74899291992186 20.43000030517579,-123.80000305175783 17.601999282836914,-122.9080047607422 14.76200008392334,-122.0679931640625 11.911999702453619,-121.27499389648439 9.05300045013428,-120.52499389648438 6.184999942779543,-119.81399536132814 3.311000108718873,-119.14100646972656 0.4300000071525574,-118.50199890136719 -2.4560000896453857,-117.89500427246095 -5.346000194549561,-117.32000732421875 -8.239999771118168,-116.77400207519534 -11.13799953460693,-116.25599670410156 -14.038000106811525,-115.76699829101562 -16.940000534057617,-115.30499267578125 -19.84300041198731,-114.87100219726562 -22.746999740600582,-114.46499633789062 -25.65099906921386,-114.08700561523439 -28.555999755859375,-113.74000549316406 -31.458999633789062,-113.42500305175783 -34.362998962402344,-113.14399719238281 -37.263999938964844,-112.9010009765625 -40.16400146484375,-112.69999694824219 -43.0620002746582,-112.54800415039062 -45.957000732421875,-112.45100402832031 -48.84899902343749,-112.42100524902344 -51.737998962402344,-112.4709930419922 -54.62200164794922,-112.6199951171875 -57.50199890136719,-112.89599609375 -60.375,-113.33399963378908 -63.24100112915039,-113.99299621582031 -66.0979995727539,-114.95799255371092 -68.94100189208984,-116.36799621582033 -71.76599884033203,-118.45799255371094 -74.56400299072266,-121.66400146484375 -77.31700134277344,-126.8560028076172 -79.98899841308595,-135.96699523925784 -82.49500274658203,-153.4429931640625 -84.5999984741211,174.75900268554688 -85.6719970703125,140.03599548339844 -84.9990005493164,119.39600372314453 -83.07099914550781,108.76599884033203 -80.63400268554688,102.84700012207031 -77.99500274658203,99.25599670410156 -75.26000213623047,96.94100189208986 -72.47499847412111,95.38899993896484 -69.65899658203126,94.32900238037111 -66.82499694824219,93.60299682617188 -63.97700119018554,93.11499786376953 -61.11899948120117,92.8030014038086 -58.25400161743163,92.6240005493164 -55.382999420166016,92.55000305175781 -52.50699996948243,92.56099700927736 -49.62799835205078,92.64099884033203 -46.744998931884766,92.77799987792969 -43.86000061035156,92.96600341796875 -40.97200012207031,93.197998046875 -38.083000183105476,93.46800231933594 -35.19200134277342,93.77300262451172 -32.29999923706055,94.11000061035156 -29.40699958801269,94.47799682617188 -26.51499938964844,94.87500000000001 -23.621999740600586,95.29900360107422 -20.729000091552734,95.75199890136719 -17.83799934387207,95.91200256347656 -16.854999542236328,90.78900146484375 -16.336000442504883,88.00499725341797 -16.0,86.03299713134766 -15.73900032043457,84.4229965209961 -15.51299953460694,82.96600341796875 -15.296999931335451,81.52200317382812 -15.07299995422364,79.95999908447266 -14.821000099182129,78.09400177001953 -14.503999710083008,75.5530014038086 -14.04800033569336,71.21399688720703 -13.203000068664545,69.81500244140625 -12.91300010681152))";
        final Storage storage = Storage.create(TestUtil.getDatasourceMongo_DB(), new GeometryFactory(GeometryFactory.Type.S2));

        final String[] args = new String[]{"-c", configDir.getAbsolutePath(), "-s", "avhrr-n17", "-start", "2007-091", "-end", "2007-093", "-v", "1.01"};
        try {
            writeSystemProperties();
            TestUtil.writeDatabaseProperties_MongoDb(configDir);

            IngestionToolMain.main(args);

            final List<SatelliteObservation> satelliteObservations = storage.get();
            assertEquals(1, satelliteObservations.size());

            final SatelliteObservation observation = satelliteObservations.get(0);
            TestUtil.assertCorrectUTCDate(2007, 4, 1, 3, 34, 54, 0, observation.getStartTime());
            TestUtil.assertCorrectUTCDate(2007, 4, 1, 5, 28, 48, 0, observation.getStopTime());
            assertEquals("avhrr-n17", observation.getSensor().getName());

            final String expectedPath = TestUtil.getTestDataDirectory().getAbsolutePath() + sep + "avhrr-n17" + sep + "1.01" + sep + "2007" + sep + "04" + sep + "01" + sep + "20070401033400-ESACCI-L1C-AVHRR17_G-fv01.0.nc";
            assertEquals(expectedPath, observation.getDataFilePath().toString());

            assertEquals(NodeType.UNDEFINED, observation.getNodeType());

            final Geometry geoBounds = observation.getGeoBounds();
            assertTrue(geoBounds instanceof GeometryCollection);
            final GeometryCollection geometryCollection = (GeometryCollection) geoBounds;
            final Geometry[] geometries = geometryCollection.getGeometries();
            assertEquals(2, geometries.length);
            assertEquals(expectedGeometry_1, geometryFactory.format(geometries[0]));
            assertEquals(expectedGeometry_2, geometryFactory.format(geometries[1]));
        } finally {
            storage.clear();
            storage.close();
        }
    }

    @Test
    public void testIngest_AVHRR_GAC_NOAA18() throws SQLException, IOException, ParseException {
        final String expectedGeometry_1 = "POLYGON((-156.6909942626953 84.4209976196289,-137.57000732421875 82.55799865722656,-127.04200744628905 80.19200134277344,-120.92999267578126 77.60800170898438,-117.12600708007812 74.91600036621094,-114.62899780273436 72.16600036621094,-112.93099975585938 69.37899780273438,-111.75399780273438 66.56900024414062,-110.93699645996094 63.74399948120117,-110.37500000000001 60.90700149536133,-110.00300598144533 58.06000137329102,-109.77799987792969 55.207000732421875,-109.66799926757814 52.34899902343749,-109.64900207519531 49.486000061035156,-109.70700073242188 46.61999893188478,-109.82800292968751 43.75199890136718,-110.00399780273439 40.88100051879883,-110.2279968261719 38.00899887084961,-110.4949951171875 35.136001586914055,-110.80000305175783 32.26200103759766,-111.13999938964844 29.38800048828125,-111.51400756835938 26.51399993896484,-111.91900634765628 23.642999649047848,-112.35400390625 20.771999359130852,-112.81900024414062 17.902000427246094,-113.31399536132814 15.036000251770025,-113.83799743652344 12.17199993133545,-114.39300537109376 9.312999725341797,-114.97900390625 6.458000183105469,-115.59700012207033 3.6080000400543217,-116.24899291992189 0.7639999985694885,-116.93600463867188 -2.0729999542236337,-117.66099548339844 -4.9019999504089355,-118.42599487304686 -7.7230000495910645,-119.23500061035156 -10.53400039672852,-120.09199523925784 -13.335000038146973,-121.0 -16.1240005493164,-121.96499633789064 -18.89900016784668,-122.99200439453126 -21.65900039672851,-124.08799743652342 -24.402999877929688,-125.26100158691408 -27.128999710083004,-126.52099609374999 -29.833999633789062,-127.87800598144531 -32.51499938964844,-129.343994140625 -35.16899871826172,-130.93499755859375 -37.79399871826172,-132.66700744628906 -40.38399887084962,-134.56100463867188 -42.935001373291016,-136.64199829101562 -45.439998626708984,-138.93800354003906 -47.89199829101563,-141.48199462890625 -50.28099822998047,-144.31399536132812 -52.59700012207031,-147.4770050048828 -54.82500076293945,-151.02200317382812 -56.94900131225586,-155.0019989013672 -58.94800186157227,-159.4709930419922 -60.797000885009766,-164.4759979248047 -62.46699905395508,-170.0500030517578 -63.92399978637696,-176.1929931640625 -65.12999725341797,177.14199829101562 -66.05000305175781,170.06100463867188 -66.64800262451172,162.72900390625 -66.90200042724611,155.3509979248047 -66.79900360107422,153.96200561523438 -66.73899841308594,151.63099670410156 -72.45999908447266,149.72500610351562 -75.41999816894531,147.87100219726562 -77.47799682617188,145.86000061035156 -79.13600158691406,143.44400024414062 -80.61900329589844,140.18099975585938 -82.06300354003906,135.0260009765625 -83.58399963378906,124.60900115966797 -85.29000091552734,92.41699981689453 -87.02400207519531,17.978000640869148 -85.48200225830078,8.600000381469727 -84.177001953125,-20.210998535156254 -84.86399841308594,-48.49600219726563 -84.0790023803711,-66.64599609375 -82.25700378417969,-77.02700805664062 -79.9469985961914,-83.21499633789062 -77.41300201416016,-87.1409912109375 -74.76699829101562,-89.75698852539062 -72.05699920654297,-91.56100463867188 -69.30699920654297,-92.83099365234375 -66.53199768066406,-93.73199462890625 -63.73799896240235,-94.36599731445314 -60.930999755859375,-94.802001953125 -58.112998962402344,-95.08700561523438 -55.2869987487793,-95.25100708007812 -52.45399856567383,-95.32000732421876 -49.613998413085916,-95.30899047851562 -46.77000045776367,-95.23098754882812 -43.922000885009766,-95.09600830078125 -41.069000244140625,-94.9119873046875 -38.21400070190429,-94.68399047851562 -35.35599899291992,-94.41598510742188 -32.49599838256836,-94.11099243164062 -29.632999420166023,-93.77301025390625 -26.77000045776366,-93.40301513671875 -23.905000686645508,-93.00201416015625 -21.040000915527344,-92.57199096679688 -18.173999786376957,-92.11099243164064 -15.309000015258789,-91.62100219726562 -12.446000099182129,-91.10101318359375 -9.583000183105465,-90.54998779296875 -6.723000049591066,-89.96701049804688 -3.865999937057495,-89.35198974609376 -1.0130000114440922,-88.70098876953125 1.8359999656677244,-88.01400756835938 4.679999828338625,-87.2860107421875 7.518000125885012,-86.51699829101562 10.348999977111816,-85.70098876953125 13.170999526977539,-84.83499145507812 15.98400020599366,-83.91299438476562 18.785999298095707,-82.93099975585938 21.576000213623047,-81.88101196289062 24.351999282836914,-80.7550048828125 27.113000869750977,-79.54501342773438 29.85600090026856,-78.239013671875 32.577999114990234,-76.82598876953125 35.277000427246094,-75.28900146484375 37.94900131225586,-73.61099243164062 40.589000701904304,-71.76998901367188 43.194000244140625,-69.74200439453125 45.75600051879883,-67.49700927734375 48.26900100708008,-64.99798583984375 50.72200012207031,-62.20300292968751 53.10599899291992,-59.063995361328125 55.40599822998047,-55.52301025390624 57.604000091552734,-51.51901245117188 59.678001403808594,-46.985992431640625 61.602001190185554,-41.86401367187501 63.345001220703125,-36.1090087890625 64.86900329589844,-29.70999145507813 66.13200378417969,-22.7139892578125 67.09100341796875,-15.239990234375005 67.70899963378906,-13.781005859375 67.78500366210938,-16.0880126953125 72.9489974975586,-17.99700927734375 75.71900177001953,-19.854003906250004 77.66799926757812,-21.861999511718746 79.2490005493164,-24.261993408203125 80.66899871826172,-27.48001098632812 82.05799865722658,-32.50900268554687 83.5250015258789,-42.47601318359375 85.17900085449219,-72.29901123046875 86.91000366210938,-146.52499389648438 85.66200256347656,-156.6909942626953 84.4209976196289))";
        final String expectedGeometry_2 = "POLYGON((153.96200561523438 -66.73899841308594,146.80799865722656 -66.22000122070312,140.03799438476562 -65.3740005493164,133.77000427246094 -64.23200225830078,128.06700134277344 -62.832000732421875,122.93399810791016 -61.21200180053711,118.34700012207031 -59.405998229980476,114.26100158691406 -57.444000244140625,110.62200164794922 -55.35200119018555,107.37699890136719 -53.152999877929695,104.4739990234375 -50.86199951171874,101.86699676513672 -48.49599838256836,99.51799774169922 -46.066001892089844,97.38999938964844 -43.58100128173828,95.4550018310547 -41.04999923706056,93.68699645996094 -38.47800064086914,92.06500244140625 -35.87099838256836,90.57099914550781 -33.23400115966797,89.19000244140625 -30.56900024414063,87.90799713134766 -27.88100051879883,86.71600341796875 -25.172000885009762,85.60099792480469 -22.44400024414063,84.55699920654297 -19.698999404907227,83.5780029296875 -16.940000534057617,82.65699768066406 -14.166999816894531,81.78700256347656 -11.381999969482425,80.96700286865234 -8.58699989318848,80.19000244140625 -5.781000137329102,79.45400238037111 -2.9670000076293936,78.75700378417969 -0.14499999582767487,78.09600067138672 2.684999942779542,77.46900177001953 5.5199999809265154,76.8740005493164 8.361000061035156,76.30999755859376 11.206000328063965,75.7770004272461 14.055999755859375,75.27300262451172 16.909000396728516,74.7979965209961 19.76499938964844,74.35299682617188 22.622999191284183,73.93699645996094 25.48299980163575,73.5530014038086 28.344999313354492,73.20099639892578 31.208000183105465,72.88200378417969 34.07099914550781,72.60199737548828 36.933998107910156,72.36100006103516 39.79600143432617,72.16600036621094 42.65800094604492,72.02200317382814 45.51800155639648,71.93800354003906 48.37699890136719,71.92500305175781 51.233001708984375,71.99600219726562 54.08499908447266,72.17199707031251 56.932998657226555,72.4800033569336 59.775001525878906,72.95600128173828 62.610000610351555,73.66000366210938 65.43599700927734,74.67400360107423 68.24800109863281,76.13300323486328 71.04100036621094,78.25700378417969 73.80400085449219,81.44000244140625 76.52100372314453,86.43199920654297 79.15599822998047,94.77899932861328 81.63099670410156,109.73699951171875 83.75199890136719,135.96200561523438 85.04399871826172,168.45399475097656 84.83999633789062,173.83599853515625 84.6259994506836,-108.18800354003906 87.55400085449219,-66.64700317382812 85.8010025024414,-55.623992919921875 84.0270004272461,-50.62298583984375 82.49299621582031,-47.593994140625 81.07299804687501,-45.415008544921875 79.6510009765625,-43.6409912109375 78.10099792480469,-42.040008544921875 76.23600006103516,-40.43701171874999 73.6800003051758,-38.587005615234375 69.27200317382812,-38.139007568359375 67.83499908447266,-30.3389892578125 67.9520034790039,-22.59201049804687 67.68499755859375,-15.1409912109375 67.05000305175781,-8.177001953125002 66.0739974975586,-1.81500244140625 64.7979965209961,3.9019999504089355 63.26399993896485,8.987999916076658 61.513999938964844,13.487999916076657 59.58399963378906,17.462999343872077 57.506999969482415,20.979000091552738 55.30899810791016,24.097000122070312 53.00999832153319,26.87299919128418 50.62900161743164,29.357000350952156 48.179000854492195,31.58900070190429 45.67100143432616,33.60499954223633 43.11399841308595,35.43600082397462 40.516998291015625,37.104999542236335 37.882999420166016,38.6349983215332 35.21900177001953,40.04299926757812 32.52899932861328,41.34299850463867 29.81699943542482,42.54800033569336 27.083999633789062,43.66999816894531 24.33399963378906,44.715999603271484 21.568000793457024,45.69499969482421 18.788999557495117,46.61399841308594 15.998000144958496,47.478000640869155 13.196999549865723,48.29199981689453 10.38599967956543,49.060001373291016 7.567999839782712,49.784999847412095 4.742000102996826,50.47100067138672 1.9110000133514404,51.120998382568374 -0.9259999990463257,51.73600006103516 -3.7660000324249268,52.31700134277344 -6.611000061035155,52.86800003051758 -9.458000183105469,53.38800048828125 -12.307999610900875,53.87699890136719 -15.159000396728516,54.3380012512207 -18.011999130249016,54.77000045776367 -20.864999771118164,55.17100143432617 -23.7189998626709,55.54199981689453 -26.57200050354004,55.88199996948242 -29.424999237060547,56.1879997253418 -32.2760009765625,56.458000183105476 -35.125999450683594,56.68899917602539 -37.9739990234375,56.8769989013672 -40.81999969482422,57.015998840332045 -43.66299819946288,57.09899902343751 -46.501998901367195,57.11800003051759 -49.3380012512207,57.05799865722657 -52.169998168945305,56.90399932861328 -54.99599838256836,56.63499832153321 -57.816001892089844,56.21799850463868 -60.62900161743164,55.609001159667955 -63.430999755859375,54.74399948120117 -66.22100067138672,53.525001525878906 -68.99400329589844,51.79499816894531 -71.74299621582031,49.29600143432617 -74.45500183105469,45.564998626708984 -77.10800170898438,39.72100067138672 -79.65599822998047,29.995000839233402 -82.0009994506836,13.003000259399414 -83.90299987792969,8.600000381469727 -84.177001953125,78.88999938964844 -87.20999908447266,121.0270004272461 -85.65599822998047,133.56199645996094 -83.90699768066406,139.35499572753906 -82.35700225830078,142.87899780273438 -80.90699768066406,145.41900634765625 -79.44200134277344,147.48800659179688 -77.83300018310547,149.35699462890625 -75.88099670410156,151.23399353027344 -73.1719970703125,153.4219970703125 -68.36199951171876,153.96200561523438 -66.73899841308594))";
        final Storage storage = Storage.create(TestUtil.getDatasourceMongo_DB(), new GeometryFactory(GeometryFactory.Type.S2));

        final String[] args = new String[]{"-c", configDir.getAbsolutePath(), "-s", "avhrr-n18", "-start", "2007-090", "-end", "2007-092", "-v", "1.02"};
        try {
            writeSystemProperties();
            TestUtil.writeDatabaseProperties_MongoDb(configDir);

            IngestionToolMain.main(args);

            final List<SatelliteObservation> satelliteObservations = storage.get();
            assertEquals(1, satelliteObservations.size());

            final SatelliteObservation observation = satelliteObservations.get(0);
            TestUtil.assertCorrectUTCDate(2007, 4, 1, 8, 4, 12, 0, observation.getStartTime());
            TestUtil.assertCorrectUTCDate(2007, 4, 1, 9, 46, 11, 0, observation.getStopTime());
            assertEquals("avhrr-n18", observation.getSensor().getName());

            final String expectedPath = TestUtil.getTestDataDirectory().getAbsolutePath() + sep + "avhrr-n18" + sep + "1.02" + sep + "2007" + sep + "04" + sep + "01" + sep + "20070401080400-ESACCI-L1C-AVHRR18_G-fv01.0.nc";
            assertEquals(expectedPath, observation.getDataFilePath().toString());

            assertEquals(NodeType.UNDEFINED, observation.getNodeType());

            final Geometry geoBounds = observation.getGeoBounds();
            assertTrue(geoBounds instanceof GeometryCollection);
            final GeometryCollection geometryCollection = (GeometryCollection) geoBounds;
            final Geometry[] geometries = geometryCollection.getGeometries();
            assertEquals(2, geometries.length);
            assertEquals(expectedGeometry_1, geometryFactory.format(geometries[0]));
            assertEquals(expectedGeometry_2, geometryFactory.format(geometries[1]));
        } finally {
            storage.clear();
            storage.close();
        }
    }

    // @todo 2 tb/tb reanimate test when we have usecase 2 running - temporarily disabled 2016-03-03
//    @Ignore
//    @Test
//    public void testIngest_AIRS() throws ParseException, IOException, SQLException {
//        // @todo 1 tb/** this testGroupInputProduct relies on the results being returned in a specifi order - change this 2015-12-22
//        // @todo 2 tb/tb move geometry factory type to some other location, parametrize testGroupInputProduct 2015-12-16
//        final Storage storage = Storage.create(TestUtil.getDatasource_H2(), new GeometryFactory(GeometryFactory.Type.JTS));
//        storage.initialize();
//
//        final String[] args = new String[]{"-c", configDir.getAbsolutePath(), "-s", "airs"};
//        try {
//            writeSystemProperties();
//            TestUtil.writeDatabaseProperties_MongoDb(configDir);
//
//            IngestionToolMain.main(args);
//
//            final List<SatelliteObservation> satelliteObservations = storage.get();
//            final SatelliteObservation observation = satelliteObservations.get(1);
//            final Sensor sensor = observation.getSensor();
//            assertTrue(sensor.getName().contains("AIRS"));
//
//            assertEquals("02-Sep-2015 02:17:22", TimeUtils.format(observation.getStartTime()));
//            assertEquals("02-Sep-2015 02:23:21", TimeUtils.format(observation.getStopTime()));
//            // @todo 1 tb/** something is wrong with the path stored in the DB check and resolve 2015-12-22
//            assertTrue(observation.getDataFilePath().toString().contains("AIRS.2015.09.02.023.L1B.AIRS_Rad.v5.0.23.0.G15246021652.hdf"));
//            assertEquals("POLYGON ((129.0250670999712 89.79658975406977, 84.86982219864322 88.25602001883792, 81.90290725421067 85.65352859896593, 81.3576435143464 83.81490908412849, 81.11962740918655 82.26953345570404, 80.9699719499203 80.78247578538293, 80.84489337073471 79.15438865050432, 80.71104039446459 77.08294691030505, 80.53453700811556 73.81603312585354, 79.3675206918862 73.81209529369254, 72.40057120621034 73.69182913234798, 65.61766811537095 73.3539676636789, 59.18281156604972 72.80034444822064, 53.20262229851623 72.05601617696243, 47.73275674707719 71.14340662799174, 42.79684164519756 70.08122973044242, 38.34567255972898 68.90462336877947, 34.37287139761094 67.61918933634195, 30.823735270859643 66.24658402113647, 27.651190877552047 64.80095475900657, 24.809181150357116 63.29386187193271, 21.850407220205888 64.21820075117444, 16.607890159954643 65.57760911279104, 12.587203385901809 66.41330926760962, 9.013604411603218 67.02699129324324, 5.402603891171518 67.53889306433688, 1.2785654966557936 68.00522531950848, -4.17068964541869 68.44711693204631, -13.074610533265286 68.77849058101255, -13.02427652238762 69.09764314472332, -12.718673119359968 71.0130353793829, -12.405163962874246 72.9280900870151, -12.080750819552595 74.84320632611005, -11.740975374740096 76.7579444858891, -11.377940291650905 78.67196596645067, -10.975842076883234 80.58535883463844, -10.505485010935299 82.49870429049207, -9.893744504161857 84.41191323747495, -8.920099154760043 86.32499905024413, -6.4170300611108315 88.23613967607469, 129.0250670999712 89.79658975406977))",
//                    observation.getGeoBounds().toString());
//
//            // @todo 1 tb/** this is not correct, check why and correct 2015-12-22
//            assertEquals(NodeType.UNDEFINED, observation.getNodeType());
//        } finally {
//            storage.clear();
//            storage.close();
//        }
//    }

    // @todo 2 tb/tb reanimate test when we have usecase 2 running - temporarily disabled 2016-03-03
//    @Test
//    public void testIngest_AMSU_MHS() throws ParseException, IOException, SQLException {
//        final Storage storage = Storage.create(TestUtil.getDatasourceMongo_DB(), new GeometryFactory(GeometryFactory.Type.S2));
//
//        final String[] args = new String[]{"-c", configDir.getAbsolutePath(), "-s", "amsub-n15", "-start", "2015-340", "-end", "2015-350", "-v", "1.0"};
//        try {
//            writeSystemProperties();
//            TestUtil.writeDatabaseProperties_MongoDb(configDir);
//            IngestionToolMain.main(args);
//            List<SatelliteObservation> satelliteObservations = storage.get();
//            assertEquals(1, satelliteObservations.size());
//            SatelliteObservation observationFromDb = satelliteObservations.get(0);
//
//
//            assertEquals(observationFromDb.getSensor().getName(), "amsub-n15");
//            assertEquals(observationFromDb.getGeoBounds().getCoordinates().length, 106);
//
//            ArrayList<Polygon> polygonArrayList = (ArrayList<Polygon>) observationFromDb.getGeoBounds().getInner();
//            Polygon polygon = polygonArrayList.get(0);
//            assertEquals("Polygon: (1) loops:\n" +
//                    "loop <\n" +
//                    "(21.409899459140426, -97.86539752771206)\n" +
//                    "(23.37569940948015, -87.36939779286331)\n" +
//                    "(24.473999381734757, -78.28879802225856)\n" +
//                    "(32.309399183795904, -79.61389798878372)\n" +
//                    "(40.14389898587979, -80.8503979575471)\n" +
//                    "(47.97329878809251, -81.99969792851334)\n" +
//                    "(55.79489859050227, -83.04969790198811)\n" +
//                    "(63.60739839314192, -83.95919787901221)\n" +
//                    "(71.41009819602914, -84.60049786281161)\n" +
//                    "(79.20129799920687, -84.45279786654282)\n" +
//                    "(86.95229780340014, -77.60479803953785)\n" +
//                    "(85.1658978485284, 83.14399789960589)\n" +
//                    "(77.40039804470145, 86.30149781984073)\n" +
//                    "(69.61679824133171, 86.1600978234128)\n" +
//                    "(61.827198438113555, 85.43649784169247)\n" +
//                    "(54.03249863502424, 84.48979786560812)\n" +
//                    "(46.23289883205871, 83.4170978927068)\n" +
//                    "(38.429999029176535, 82.25039792218013)\n" +
//                    "(30.625799226327217, 80.99789795382094)\n" +
//                    "(22.824399423407158, 79.65619798771513)\n" +
//                    "(15.030799620290047, 78.21409802414564)\n" +
//                    "(7.251599816809179, 76.65309806357982)\n" +
//                    "(-0.5048999872451532, 74.94649810669216)\n" +
//                    "(-8.228299792135662, 73.0563981544401)\n" +
//                    "(-15.906599598165483, 70.92909820818022)\n" +
//                    "(-23.523499405746406, 68.48709826987033)\n" +
//                    "(-30.00809924193164, 66.04839833147707)\n" +
//                    "(-32.292799184215255, 77.71499803675397)\n" +
//                    "(-33.357899157308566, 87.94689777827443)\n" +
//                    "(-25.573299353964103, 89.21159774632542)\n" +
//                    "(-17.788399550627222, 90.57729771182494)\n" +
//                    "(-10.009099747148863, 92.05809767441679)\n" +
//                    "(-2.242899943339581, 93.67609763354267)\n" +
//                    "(5.50149986102042, 95.46419758837146)\n" +
//                    "(13.212299666229224, 97.46889753772851)\n" +
//                    "(20.874799472658196, 99.75799747990095)\n" +
//                    "(28.469099280810042, 102.43129741236771)\n" +
//                    "(35.96709909139463, 105.64229733125103)\n" +
//                    "(43.32499890551844, 109.63469723039455)\n" +
//                    "(50.47019872501551, 114.81299709957966)\n" +
//                    "(57.270398553228006, 121.87539692116844)\n" +
//                    "(63.46869839664578, 132.0412966643562)\n" +
//                    "(68.54659826836723, 147.2297962806624)\n" +
//                    "(71.56179819219687, 168.993895730855)\n" +
//                    "(71.47999819426332, -165.71089581379056)\n" +
//                    "(68.33329827375564, -144.24439635607996)\n" +
//                    "(63.17339840410568, -129.34169673255383)\n" +
//                    "(56.921898562031856, -119.36029698470523)\n" +
//                    "(50.08059873485763, -112.40929716030223)\n" +
//                    "(42.89839891629528, -107.29989728937656)\n" +
//                    "(35.504099103090994, -103.35219738910382)\n" +
//                    "(27.969099293441104, -100.17149746945506)\n" +
//                    ">\n", polygon.toString());
//
//
//        } finally {
//            storage.clear();
//            storage.close();
//        }
//    }

    private void writeSystemProperties() throws IOException {
        final Properties properties = new Properties();
        properties.setProperty("archive-root", TestUtil.getTestDataDirectory().getAbsolutePath());
        properties.setProperty("geometry-library-type", "S2");
        TestUtil.storePropertiesToTemp(properties, configDir, "system.properties");
    }
}
